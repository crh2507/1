<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <title>Wallet Explorer PWA</title>
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <link rel="manifest" href="manifest.json" />
 <meta name="theme-color" content="#0A74DA" />
 <style>
   body { font-family: Arial, sans-serif; padding: 2em; }
   .hidden { display: none; }
   input, select, button, textarea {
     padding: 0.5em;
     margin: 0.3em 0.6em 0.6em 0;
     font-size: 1em;
   }
   table { width: 100%; border-collapse: collapse; margin-top: 1em; }
   th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
   textarea { width: 100%; height: 150px; }
 </style>
</head>
<body>

 <h1>üîê Wallet Explorer (Offline-Ready)</h1>

 <div id="loginForm">
   <input type="text" id="loginInput" placeholder="Enter wallet phone (e.g. 6717770001)" />
   <button onclick="login()">Login</button>
 </div>

 <div id="walletView" class="hidden">
   <h2>üì± Wallet: <span id="userPhone"></span></h2>
   <p><strong>Balance:</strong> <span id="balanceDisplay"></span> coins</p>
   <p><strong>Status:</strong> <span id="statusDisplay"></span></p>

   <h3>üì§ Send Coins</h3>
   <input type="text" id="recipientInput" placeholder="Recipient phone" />
   <input type="number" id="amountInput" placeholder="Amount" />
   <button onclick="sendCoins()">Send</button>

   <h3>üìö Transaction History</h3>
   <label>Filter:
     <select id="filterType" onchange="renderHistory(currentUser)">
       <option value="all">All</option>
       <option value="send">Sent</option>
       <option value="receive">Received</option>
     </select>
   </label>
   <button onclick="exportHistory()">‚¨áÔ∏è Export CSV</button>

   <table id="transactionTable">
     <thead><tr><th>Type</th><th>Counterparty</th><th>Amount</th><th>Time</th></tr></thead>
     <tbody></tbody>
   </table>

   <h3>üì¶ Wallet Snapshot</h3>
   <button onclick="exportSnapshot()">üß† Export Snapshot</button>
   <textarea id="snapshotOutput" readonly></textarea>

   <h3>üîÅ Restore from Snapshot</h3>
   <textarea id="snapshotInput" placeholder="Paste JSON here"></textarea>
   <button onclick="importSnapshot()">Restore</button>
 </div>

 <script>
   let currentUser = null;

   function login() {
     const input = document.getElementById('loginInput').value.trim();
     if (!input.match(/^671777\d{4}$/)) {
       alert('Invalid wallet phone');
       return;
     }
     currentUser = input;
     document.getElementById('userPhone').textContent = currentUser;
     document.getElementById('loginForm').classList.add('hidden');
     document.getElementById('walletView').classList.remove('hidden');
     initWallet(currentUser);
     renderWallet(currentUser);
     renderHistory(currentUser);
   }

   function initWallet(phone) {
     const key = 'wallet-' + phone;
     const logKey = key + '-logs';
     if (!localStorage.getItem(key)) {
       localStorage.setItem(key, JSON.stringify({ phone, coins: 100, status: 'active' }));
       localStorage.setItem(logKey, JSON.stringify([]));
     }
   }

   function getWallet(phone) {
     return JSON.parse(localStorage.getItem('wallet-' + phone) || '{}');
   }

   function saveWallet(wallet) {
     localStorage.setItem('wallet-' + wallet.phone, JSON.stringify(wallet));
   }

   function logTransaction(phone, entry) {
     const logs = JSON.parse(localStorage.getItem('wallet-' + phone + '-logs') || '[]');
     logs.push(entry);
     localStorage.setItem('wallet-' + phone + '-logs', JSON.stringify(logs));
   }

   function sendCoins() {
     const to = document.getElementById('recipientInput').value.trim();
     const amount = parseFloat(document.getElementById('amountInput').value.trim());
     if (!to.match(/^671777\d{4}$/) || isNaN(amount) || amount <= 0) {
       alert('Invalid transfer details'); return;
     }
     const sender = getWallet(currentUser);
     const receiver = getWallet(to) || { phone: to, coins: 100, status: 'new' };
     if (sender.coins < amount) { alert('Insufficient balance'); return; }

     sender.coins -= amount;
     receiver.coins += amount;
     saveWallet(sender); saveWallet(receiver);

     const now = new Date().toISOString();
     logTransaction(currentUser, { type: 'send', to, amount, time: now });
     logTransaction(to, { type: 'receive', from: currentUser, amount, time: now });

     renderWallet(currentUser);
     renderHistory(currentUser);
     alert(`Sent ${amount} coins to ${to}`);
   }

   function renderWallet(phone) {
     const wallet = getWallet(phone);
     document.getElementById('balanceDisplay').textContent = wallet.coins;
     document.getElementById('statusDisplay').textContent = wallet.status;
   }

   function renderHistory(phone) {
     const logs = JSON.parse(localStorage.getItem('wallet-' + phone + '-logs') || '[]');
     const filter = document.getElementById('filterType').value;
     const tbody = document.querySelector('#transactionTable tbody');
     tbody.innerHTML = '';

     logs.filter(l => filter === 'all' || l.type === filter).forEach(log => {
       const row = document.createElement('tr');
       row.innerHTML = `
         <td>${log.type}</td>
         <td>${log.to || log.from}</td>
         <td>${log.amount}</td>
         <td>${new Date(log.time).toLocaleString()}</td>
       `;
       tbody.appendChild(row);
     });
   }

   function exportHistory() {
     const logs = JSON.parse(localStorage.getItem('wallet-' + currentUser + '-logs') || '[]');
     let csv = 'type,counterparty,amount,time\n';
     logs.forEach(l => {
       const party = l.to || l.from;
       csv += `${l.type},${party},${l.amount},"${new Date(l.time).toLocaleString()}"\n`;
     });
     const blob = new Blob([csv], { type: 'text/csv' });
     const a = document.createElement('a');
     a.href = URL.createObjectURL(blob);
     a.download = `wallet-${currentUser}-history.csv`;
     document.body.appendChild(a); a.click(); document.body.removeChild(a);
   }

   function exportSnapshot() {
     const wallet = getWallet(currentUser);
     const logs = JSON.parse(localStorage.getItem('wallet-' + currentUser + '-logs') || '[]');
     document.getElementById('snapshotOutput').value = JSON.stringify({ wallet, logs }, null, 2);
   }

   function importSnapshot() {
     try {
       const input = JSON.parse(document.getElementById('snapshotInput').value.trim());
       saveWallet(input.wallet);
       localStorage.setItem('wallet-' + input.wallet.phone + '-logs', JSON.stringify(input.logs));
       alert('Snapshot restored');
       if (input.wallet.phone === currentUser) {
         renderWallet(currentUser);
         renderHistory(currentUser);
       }
     } catch (e) { alert('Invalid snapshot format'); }
   }

   // Register Service Worker for offline support
   if ('serviceWorker' in navigator) {
     navigator.serviceWorker.register('sw.js').then(() => console.log('‚úÖ Service Worker registered'));
   }
 </script>

</body>
</html>
