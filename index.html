<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <title>Modular Wallet Explorer</title>
 <style>
   body { font-family: Arial, sans-serif; padding: 2em; }
   .hidden { display: none; }
   input, select, button {
     padding: 0.5em;
     margin: 0.3em 0.6em 0.6em 0;
     font-size: 1em;
   }
   table { width: 100%; border-collapse: collapse; margin-top: 1em; }
   th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
   #transactionTable { margin-top: 1em; }
 </style>
</head>
<body>

 <h1>üîê Wallet Login</h1>

 <div id="loginForm">
   <input type="text" id="loginInput" placeholder="Enter wallet phone (e.g. 6717770001)" />
   <button onclick="login()">Login</button>
 </div>

 <div id="walletView" class="hidden">
   <h2>üì± Wallet: <span id="userPhone"></span></h2>
   <p><strong>Balance:</strong> <span id="balanceDisplay"></span> coins</p>
   <p><strong>Status:</strong> <span id="statusDisplay"></span></p>

   <h3>üì§ Send Coins</h3>
   <input type="text" id="recipientInput" placeholder="Recipient phone" />
   <input type="number" id="amountInput" placeholder="Amount" />
   <button onclick="sendCoins()">Send</button>

   <h3>üìö Transaction History</h3>
   <label>Filter:
     <select id="filterType" onchange="renderHistory(currentUser)">
       <option value="all">All</option>
       <option value="send">Sent</option>
       <option value="receive">Received</option>
     </select>
   </label>
   <button onclick="exportHistory()">‚¨áÔ∏è Export to CSV</button>

   <table id="transactionTable">
     <thead><tr><th>Type</th><th>Counterparty</th><th>Amount</th><th>Time</th></tr></thead>
     <tbody></tbody>
   </table>
 </div>

 <script>
   let currentUser = null;

   function login() {
     const input = document.getElementById('loginInput').value.trim();
     if (!input.match(/^671777\d{4}$/)) {
       alert('Enter a valid wallet phone number');
       return;
     }

     currentUser = input;
     document.getElementById('userPhone').textContent = currentUser;
     document.getElementById('loginForm').classList.add('hidden');
     document.getElementById('walletView').classList.remove('hidden');

     initWallet(currentUser);
     renderWallet(currentUser);
     renderHistory(currentUser);
   }

   function initWallet(phone) {
     const key = 'wallet-' + phone;
     const logKey = key + '-logs';
     if (!localStorage.getItem(key)) {
       const wallet = { phone, coins: 100, status: 'active' };
       localStorage.setItem(key, JSON.stringify(wallet));
       localStorage.setItem(logKey, JSON.stringify([]));
     }
   }

   function getWallet(phone) {
     const wallet = localStorage.getItem('wallet-' + phone);
     return wallet ? JSON.parse(wallet) : null;
   }

   function saveWallet(wallet) {
     localStorage.setItem('wallet-' + wallet.phone, JSON.stringify(wallet));
   }

   function logTransaction(phone, entry) {
     const key = 'wallet-' + phone + '-logs';
     const logs = JSON.parse(localStorage.getItem(key) || '[]');
     logs.push(entry);
     localStorage.setItem(key, JSON.stringify(logs));
   }

   function sendCoins() {
     const recipient = document.getElementById('recipientInput').value.trim();
     const amount = parseFloat(document.getElementById('amountInput').value.trim());

     if (!recipient.match(/^671777\d{4}$/) || isNaN(amount) || amount <= 0) {
       alert('Enter valid recipient and amount');
       return;
     }

     const sender = getWallet(currentUser);
     const receiver = getWallet(recipient) || { phone: recipient, coins: 100, status: 'new' };

     if (sender.coins < amount) {
       alert('Insufficient balance');
       return;
     }

     sender.coins -= amount;
     receiver.coins += amount;

     saveWallet(sender);
     saveWallet(receiver);

     logTransaction(currentUser, {
       type: 'send',
       to: recipient,
       amount,
       time: new Date().toISOString()
     });

     logTransaction(recipient, {
       type: 'receive',
       from: currentUser,
       amount,
       time: new Date().toISOString()
     });

     renderWallet(currentUser);
     renderHistory(currentUser);
     alert(`Sent ${amount} coins to ${recipient}`);
   }

   function renderWallet(phone) {
     const wallet = getWallet(phone);
     document.getElementById('balanceDisplay').textContent = wallet.coins;
     document.getElementById('statusDisplay').textContent = wallet.status;
   }

   function renderHistory(phone) {
     const key = 'wallet-' + phone + '-logs';
     const logs = JSON.parse(localStorage.getItem(key) || '[]');
     const filter = document.getElementById('filterType').value;

     const tbody = document.querySelector('#transactionTable tbody');
     tbody.innerHTML = '';

     logs.filter(log => filter === 'all' || log.type === filter).forEach(log => {
       const row = document.createElement('tr');
       row.innerHTML = `
         <td>${log.type}</td>
         <td>${log.to || log.from}</td>
         <td>${log.amount}</td>
         <td>${new Date(log.time).toLocaleString()}</td>
       `;
       tbody.appendChild(row);
     });
   }

   function exportHistory() {
     const key = 'wallet-' + currentUser + '-logs';
     const logs = JSON.parse(localStorage.getItem(key) || '[]');

     if (!logs.length) {
       alert('No transaction history to export.');
       return;
     }

     let csv = 'type,counterparty,amount,time\n';
     logs.forEach(log => {
       const party = log.to || log.from;
       csv += `${log.type},${party},${log.amount},"${new Date(log.time).toLocaleString()}"\n`;
     });

     const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
     const link = document.createElement('a');
     link.href = URL.createObjectURL(blob);
     link.download = `wallet-${currentUser}-history.csv`;
     document.body.appendChild(link);
     link.click();
     document.body.removeChild(link);
   }
 </script>

</body>
</html>
